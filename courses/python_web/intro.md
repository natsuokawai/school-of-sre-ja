# PythonとWeb

## 前提条件

- Python言語の基本的な理解
- Flaskフレームワークの基本的な知識

## このコースで扱うこと

このコースは2つのハイレベルなパートに分かれています。最初のパートでは、Python言語の基本的な操作や構文の使い方を知っていることを前提に、言語としてのPythonをもう少し深く理解します。また、Pythonのオブジェクトの概念を探り、それをもとにデコレータのようなPythonの機能を探ります。

第2部ではウェブを中心に展開し、Flaskフレームワークを使い慣れていることを前提に、ソケットモジュールから始めて、HTTPリクエストを扱います。これにより、Flaskのようなフレームワークが内部でどのように動作するかを解明します。

また、このコースでSREの雰囲気を感じてもらうために、URL短縮アプリケーションを設計、開発、デプロイします（理論的には）。このコースでは、アプリやサービスのSREとしてより重要なプロセスの部分に注目します。

## このコースでは扱わないこと

Pythonの内部構造や高度なPythonの知識。

## ラボ環境のセットアップ

最新バージョンのPythonがインストールされていること。

## コース内容

1. [Python言語](/python_web/intro/#the-python-language/)
      1. [Pythonの概念](/python_web/python-concepts/)
      2. [いくつかの落とし穴](/python_web/python-concepts/#some-gotchas)
2. [PythonとWeb](/python_web/python-web-flask/)
      1. [ソケット](/python_web/python-web-flask/#sockets)
      2. [Flask](/python_web/python-web-flask/#flask)
3. [URL短縮アプリ](/python_web/url-shorten-app/)
      1. [設計](/python_web/url-shorten-app/#design)
      2. [アプリのスケーリング](/python_web/sre-conclusion/#scaling-the-app)
      3. [アプリの監視](/python_web/sre-conclusion/#monitoring-strategy)

## Python言語

C/C++とJavaを少し知っていると仮定して、これら2つの言語とpythonの文脈で以下の質問を議論してみましょう。C/C++はコンパイル言語で、pythonはインタプリタ言語であると聞いたことがあるかもしれません。一般的に、コンパイル言語では、まずプログラムをコンパイルしてから実行ファイルを実行しますが、pythonの場合は、`python hello_world.py`のようにソースコードを直接実行します。一方、インタプリタ型言語であるJavaの場合は、コンパイルと実行が別々に行われます。では、実際には何が違うのでしょうか？

### コンパイラとインタプリタの違い

奇妙に聞こえるかもしれませんが、Pythonはある意味ではコンパイル言語です。Pythonはコンパイラを内蔵しています。Javaの場合は、`javac helloWorld.java`のように別のコマンドを使ってコンパイルし、_バイトコード_ として知られている`.class`ファイルが生成されるので、明らかです。さて、Pythonもこれとよく似ています。一つの違いは、Pythonプログラムを実行するために必要な別のコンパイルコマンド/バイナリがないことです。

**JavaとPythonの違いは何でしょうか？**
Javaのコンパイラはより厳密で洗練されています。ご存知のように、Javaは静的型付け言語です。そのため、コンパイラはコンパイル時に型に関するエラーを検証できるように書かれています。一方、Pythonは _動的_ 言語であり、プログラムが実行されるまで型はわかりません。ですから、ある意味ではPythonのコンパイラは間抜け（というか、あまり厳密ではない）なのです。しかし、Pythonのプログラムが実行されるときには、確かにコンパイルのステップがあります。Python のバイトコードファイルの拡張子が`.pyc`であるのを見たことがあるかもしれません。以下は、あるPythonプログラムのバイトコードを見る方法です。

```bash
# Hello Worldの作成
$ echo "print('hello world')" > hello_world.py

# 実行されることを確認
$ python3 hello_world.py
hello world

# プログラムのバイトコード
$ python -m dis hello_world.py
 1           0 LOAD_NAME                0 (print)
             2 LOAD_CONST               0 ('hello world')
             4 CALL_FUNCTION            1
             6 POP_TOP
             8 LOAD_CONST               1 (None)
            10 RETURN_VALUE
```

disモジュールの詳細は[こちら](https://docs.python.org/ja/3/library/dis.html)

C/C++については、もちろんコンパイラがあります。しかし、その出力はJava/Pythonのコンパイラが出力するものとは異なります。C言語のプログラムをコンパイルすると、「マシンコード」と呼ばれるものが生成されます。バイトコードとは異なります。

### プログラムの実行

ここで取り上げる3つの言語は、いずれもコンパイルが必要です。ただ、コンパイラの性質が異なり、出力される内容も異なります。C/C++の場合、出力されるのはマシンコードで、OSが直接読むことができます。そのプログラムを実行すると、OSはそのプログラムを正確に実行する方法を知ることができます。**しかし、バイトコードの場合はそうはいきません。**

それらのバイトコードは言語固有のものです。Pythonには独自のバイトコードが定義されていますし（詳しくは`dis`モジュールで）、Javaも同様です。ですから当然ながら、あなたのオペレーティングシステムはそれを実行する方法を知りません。このバイトコードを実行するために、仮想マシンというものがあります。例えば、JVMやPython VM（CPython、Jython）などです。これらの仮想マシンと呼ばれるものは、バイトコードを読み込んで、所定のオペレーティングシステム上で実行することができるプログラムです。Pythonには複数のVMが用意されています。CpythonはC言語で実装されたPython VMで、同様にJythonはPython VMのJava実装です。**結局のところ、 VMの能力はPython言語の構文を理解し、それをバイトコードにコンパイルし、そのバイトコードを実行することができることです。** PythonのVMはどんな言語でも実装できます！（そしてそれができるからといって、実際に自作している人もいます）

```
                                                              The Operating System

                                                              +------------------------------------+
                                                              |                                    |
                                                              |                                    |
                                                              |                                    |
hello_world.py                    Python bytecode             |         Python VM Process          |
                                                              |                                    |
+----------------+                +----------------+          |         +----------------+         |
|print(...       |   COMPILE      |LOAD_CONST...   |          |         |Reads bytecode  |         |
|                +--------------->+                +------------------->+line by line    |         |
|                |                |                |          |         |and executes.   |         |
|                |                |                |          |         |                |         |
+----------------+                +----------------+          |         +----------------+         |
                                                              |                                    |
                                                              |                                    |
                                                              |                                    |
hello_world.c                     OS Specific machinecode     |         A New Process              |
                                                              |                                    |
+----------------+                +----------------+          |         +----------------+         |
|void main() {   |   COMPILE      | binary contents|          |         | binary contents|         |
|                +--------------->+                +------------------->+                |         |
|                |                |                |          |         |                |         |
|                |                |                |          |         |                |         |
+----------------+                +----------------+          |         +----------------+         |
                                                              |         (binary contents           |
                                                              |         runs as is)                |
                                                              |                                    |
                                                              |                                    |
                                                              +------------------------------------+
```

上の図の注意点は2つあります。

1. 一般的に、Pythonプログラムを実行するとPython VMプロセスが開始され、Pythonのソースコードを読み、バイトコードにコンパイルして、1つのステップで実行します。コンパイルは別のステップではありません。説明のためにのみ表示されています。
2. C言語のような言語用に生成されたバイナリは、そのままでは正確には実行されません。バイナリには複数の種類（例：ELF）があるため、バイナリを実行するためにはより複雑な手順が必要となりますが、これらはすべてOSレベルで行われるため、ここでは触れません。
